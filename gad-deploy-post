#!/bin/bash

HOSTNAME="$1"
WEBROOT=${2:-/var/www/html}
REPODIR="/var/repos"
GITIGNORE="${REPODIR}/${HOSTNAME}/.gitignore"
[ -f "$GITIGNORE" ] || { echo "gitignore not found"; exit 1; }
rsync -r \
	--exclude-from="$GITIGNORE" \
	--delete \
 	${REPODIR}/${HOSTNAME}/ ${HOSTNAME}:${WEBROOT}
if [ ! $? -eq 0 ]; then
	notify-critical "rsync exited with code $? for ${LOGNAME}@${HOSTNAME} while attempting to deploy ${HOSTNAME}"
fi

wordpress-permissions "$HOSTNAME" dev
if [  $? -eq 0 ]; then
	notify "Deploy complete for ${HOSTNAME}:${WEBROOT} by ${LOGNAME}@${HOSTNAME}"
else
	notify-critical "wordpress-permissions exited with code $? for ${LOGNAME}@${HOSTNAME} while attempting to deploy ${HOSTNAME}"
fi

exit 0
