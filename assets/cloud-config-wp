#cloud-config

users:
  - name: dev
    ssh-authorized-keys:
  - [PUBLICKEY]
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
runcmd:
  - sed -i -e '/^Port/s/^.*$/Port [SSHDPORT]/' /etc/ssh/sshd_config
  - sed -i -e '/^PermitRootLogin/s/^.*$/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i -e '$aAllowUsers dev' /etc/ssh/sshd_config
  - service ssh restart
  - ufw default incoming disabled
  - ufw allow 9999/tcp
  - ufw allow http
  - ufw allow https
  - ufw allow from [ADMINIP]
  - ufw --force enable
  - apt-get update
  - apt-get -y upgrade
  - apt-get -y install git php-curl php-gd php-mbstring php-mcrypt php-xml php-xmlrpc glances vim software-properties-common curl
  - add-apt-repository -y ppa:olipo186/git-auto-deploy
  - apt-get update
  - apt-get -y install git-auto-deploy
  - gpasswd -a dev git-auto-deploy
  - gpasswd -a www-data git-auto-deploy
  - mkdir -p /var/www/html
  - mkdir /var/www/staging
  - chown -R git-auto-deploy:git-auto-deploy /var/www
  - chown dev:dev /var/www
  - chmod g+w -R /var/www
  - curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
  - chmod +x wp-cli.phar
  - mv wp-cli.phar /usr/local/bin/wp
  - fallocate -l 4G /swapfile  
  - chmod 600 /swapfile  
  - mkswap /swapfile  
  - swapon /swapfile
  - printf "\n/swapfile   none    swap    sw    0   0" >> /etc/fstab
  - rm -f /var/www/html/*
  - ln -s /var/www /home/dev/www
  - mysql -e "create database live; create user 'wp'@'localhost' identified by 'PASSWORD'; grant all privileges on live.* to 'wp'@'localhost'; flush privileges;"
