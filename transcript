I hear you would like to migrate a site from pantheon to DO
From:Dominic I would, can you give me about 20mins?
Sure np
From:Dominic cool
From:Dominic sorry just wrapping up a production meetingFrom:Dominic ok all good, sorry about that Ok good timing
The key to doing this in the terminal is to use the Pantheon tool terminus I have an administration droplet setup with terminus installed so I don't have to set it up every time. The other nice thing about having an admin droplet is that your upload speed from there to web server is like a gigabit. 500x speed of the office.
From:Dominic oh nice
Do you want to make your own admin droplet?
From:Dominic sure
Ok, $5 ubuntu 16.04 64 bit nothing fancy
Your will login as root, and then make a new user like this: adduser dom
From:Dominic new york datacenter?
Ideally you want to use a dc where you dont host websites, for redundancy
In case NY blows up
From:Dominic alright
From:Dominic ok thats set up Ok, your user nees sudo access. As root, run
gpasswd -a dom sudo That will add him to the sudo group
From:Dominic ok
You also need some software, so
apt-get update; apt-get -y install curl git
From:Dominic ok thats done
Alright now login as dom
Test sudo access, sudo ls
From:Dominic yup it works
Cool, so your droplet will ne a lot more secire if we disable root login over ssh. You need to edit /etc/ssh/sshd_config
You may want to use nano as an editor
From:Dominic ok got the file open in nano
Did you open it using sudo?
From:Dominic no
You have to or it's read only
From:Dominic ok
From:Dominic ok there we go I think the line is PermitRootLogin change yes to no
From:Dominic ok
Alright save the file and run
From:Dominic saved those changes
sudo service ssh restart
From:Dominic alright
Now you need terminus
pantheon-systems/terminusterminus - The Pantheon CLI — a standalone utility for performing operations on the Pantheon Platform GitHub
I believe that if you curl the .phar file and then mv that to your /usr/local/bin dir as terminus it will work
Let me know if I can help with anything Uh, looks like they've changed things on me.
From:Dominic just setting ssh key for user dom so I can still log in
When youre ready to make the WordPress droplet, you will use a script during creation by checking the box for User Data and pasting in this: https://gitlab.com/neilscudder/wp-admin/blob/master/assets/cloud-config-wpassets/cloud-config-wp · master · Neil / wp-adminGitLab.com GitLab
I recommend you enable the ipv6 and backup options as well at that time. This script works with the LEMP 16.04 one-click configuration. Start with a $5 droplet and only resize after the droplet is provisioned.
You must update the script with a public key from user dom at the admin droplet, and put in the ip of your admin droplet so it is allowed through the firewall. See the ALL CAPS TAGS in the script
From:Nathaniel Tubb Hey Neil we are renaming the .phar file to terminus?
From:Nathaniel Tubb there is a php installer part to the github instructions No sorry I was wrong.
Try running the installer as they recommend. You may need to run it as root.
From:Nathaniel Tubb no php installed
Ok
sudo apt-get -y install php-cli php-curl That should pull in all the other dependencies you need Removed on Jun 20 at 3:34 pmMessage removedRemoved on Jun 20 at 3:34 pmMessage removedRemoved on Jun 20 at 3:33 pmMessage removedRemoved on Jun 20 at 3:34 pmMessage removedThe installer instructions are here: https://github.com/pantheon-systems/terminus-installerpantheon-systems/terminus-installerterminus-installer - Installer for Pantheon Terminus GitHub
These guys get me every time
If you want I can log in and set it up for you. Once you have Terminus installed you need to generate a machine token in your Pantheon dashboard. It will give you a command to paste into the terminal which will authorize terminus. You also need to add the public key for user dom to the SSH keys in your Pantheon account Then you can generate and download your db and files with three commands: terminus backup:create site-name.live
From:Nathaniel Tubb fyi, we needed to install php-xml for terminus to run
terminus backup:get site-name.live --to=./backup.sql.gz --element=db
terminus backup:get site-name.live --to=./files.tgz --element=files Ok cool, nice work How's it going?
From:Dominic so far so good, just creating the backups
Great, have you made the wp droplet?
From:Dominic not yet
Is this a high traffic site like Pen?
From:Dominic nope
Good
That will keep things simpleAfter you have the droplet you can use this script to install wp and setup a default database. You need a domain pointing to the droplet before you run the script, something like dev.client.com so LetsEncrypt can issue a cert. https://gitlab.com/neilscudder/wp-admin/blob/master/wordpress-installwordpress-install · master · Neil / wp-adminGitLab.com GitLab
Later we will change the nginx configuration to the live domain, and run LetsEncrypt for it. This is a non-disruptive way to test the server configuration before going live.
When you make the wp droplet with the cloud-config script it will take about 10 minutes after droplet creation for that script to complete. Once it has, you can login as user dev on port 9999 with the matching key to the one used in the cloud-config script. The WordPress install script uses a function which is useful for one reason only in this case: it keeps the local variables from interfering with anything outside of that function. If I were to declare a variable called user outside of a function it might conflikt with the system's idea of what a user is. You will have to clone the repo to use that script as it relies on some other assets How's it going guys?
From:Dominic setting up wp atm, whats FQDN?
Fully qualified domain name
From:Dominic Do we need to enter both the domain with www and without or one or the other?
Just the bare domain
What the script is doing is setting up the database and give you a config file to use when you clone the actual site from Pantheon. You want to throw away the configuration from Pantheon. Then you can import the line in from the terminus backup using wp-cli wp db import ~/live.sql Neil Scudder - Today 17:20> Then you can import the line in from the terminus backup using wp-cliSorry, import the db
From:Dominic When running the wordpress-install [ip] from our admin box it is showing
From:Dominic dom@dom-admin-droplet:~$ wordpress-install 104.236.147.126Database host: [localhost]Database user: [wp]Database name: [live]Database password: nur(Z+mMzRm+FQDN: roammedia.caSite title: [Title] Roam MediaUser: [admin]Password: passwordEmail: dom@mediumrareinc.com'assets/nginx-letsencrypt' -> '/tmp/nginx-letsencrypt''assets/nginx-snippets/gzip-wordpress.conf' -> '/tmp/nginx-snippets/gzip-wordpress.conf''assets/nginx-snippets/ssl-certs.conf' -> '/tmp/nginx-snippets/ssl-certs.conf''assets/nginx-snippets/ssl-params.conf' -> '/tmp/nginx-snippets/ssl-params.conf''assets/nginx-wordpress' -> '/tmp/nginx-wordpress'Permission denied (publickey).lost connectionPermission denied (publickey).Permission denied (publickey).Permission denied (publickey).Permission denied (publickey).ssh: connect to host 104.236.147.126 port 22: Connection refusedssh: connect to host 104.236.147.126 port 22: Connection refusedssh: connect to host 104.236.147.126 port 22: Connection refusedssh: connect to host 104.236.147.126 port 22: Connection refused Okay you need to setup your SSH config file
From:DominicHost roammediaHostName www.roammedia.caPort 22User devIdentityFile ~/.ssh/id_rsa
Right, use roammedia where you used the IP address before
From:Dominic We have had to do a DNS swap which it taking a while
From:Dominic Hence the IP wordpress-install roammedia
Oh Change the hostname line to use the ip
From:Dominic cool
From:Amanda Woloshyn Someone is going to copy paste clean the documentation right 
But letsencrypt won't work until the domain resolves
Good idea Amanda Dom, you need to have the domain working before you run that script If letsencrypt setup fails I'm not sure things will finish cleanly We could pick this up tomorrow maybe. There's the whole topic of git Auto deploy still on top of this.
From:Dominic At the Let’sEncrypt stage it is asking for root password
From:Dominic ?From:Dominic Connection to 104.236.147.126 closed.sudo: no tty present and no askpass program specifiedEnter password: Hmmm, something may have gone sideways in the cloud config stage. Your user should have passwords access.
Passwordless My Shaw internet has been down for 20 minutes so bear with me on my phone here If you can set me up with access I could help you diagnose this and we can get to the bottom of the quickly
From:Dominic sure
Add this to your ~/.ssh/authorized_hosts    file on admin droplet please:
ecdsa-sha2-nistp384 AAAAE2VjZHNhLXNoYTItbmlzdHAzODQAAAAIbmlzdHAzODQAAABhBCMsdooJhXPYMscBbk9ihD45zA0A5wOj2BATT2DGVn0esrfnKy4+mm7PzLGmeMNL7mPvVyPBgi5QC2q2DRppzj5KGJrSTk4xmAwTwbzNhCQBxPJJSHIy8IxojsGV85wk9A== JuiceSSH And tell me the ip
From:Dominic 198.199.112.218
Oh, and you need to do this
chmod 600 ~/.ssh/authorized_hosts Pleade s
From:Dominic ok
What's your username?
From:Dominic should be dom
It's not working
From:Dominic do i need to run sudo services ssh restart?
Try it
From:Dominic ok try that
Hmm, let's try disabling password login in the SSH configuration
sudo nano /etc/ssh/sshd_config Look for the line about clear text passwords
From:Dominic set to no
From:Dominic already^ You're in the web server
Right?
From:Dominic yea
Is that where you put my public key?
From:Dominic yea
From:Dominic i put it into ~/.ssh/authorized_hostsFrom:Dominic should it be keys instead of hosts?From:Dominic try that Oh, this IS your admin droplet 
In now, yes good catch my mistake
From:Dominic nathaniel caught it
Okay I need to take a break but I will look at everything and test the cloud config script myself on another droplet to see what went wrong.
From:Dominic alright, client wants to launch asap, either later tonight or early tomorrow
From:Dominic I should still be around later tonight if you’re up for it We can do it tonight
From:Dominic sounds good
Alright Dom, I have just deployed https://cloudtest.neilscudder.com to test the cloud-config and wordpress-install scripts, both of which worked great. It will be faster to deploy a new wordpress droplet than to try and fox the botched one, so I suggest you delete it and deploy again. Make sure you put your ssh key and ip in there before pasting into the user data box. Be sure to use the one-click-app for LEMP on 16.04 x64
Your admin droplet looks great
Before you change the DNS again let me verify that it worked this time
From:Dominic ok, will recreate now
From:Dominichmmm still getting that error trying to install wordpressFailed authorization procedure. roammedia.ca (http-01): urn:acme:error:connection :: The server could not connect to the client to verify the domain :: Fetching http://roammedia.ca/.well-known/acme-challenge/6rYWNntAcO-9lDeHAbUe6ViQH9tvecou4N2DhKQ3bA8: TimeoutIMPORTANT NOTES:- If you lose your account credentials, you can recover throughe-mails sent to maintenance@mediumrareinc.com.- The following errors were reported by the server:Domain: roammedia.caType: connectionDetail: Fetching http://roammedia.ca/.well-known/acme-challenge/6rYWNntAcO-9lDeHAbUe6ViQH9tvecou4N2DhKQ3bA8: TimeoutTo fix these errors, please make sure that your domain name wasentered correctly and the DNS A record(s) for that domaincontain(s) the right IP address. Additionally, please check thatyour computer has a publicly routable IP address and that nofirewalls are preventing the server from communicating with theclient. If you're using the webroot plugin, you should also verifythat you are serving files from the webroot path you provided.- Your account credentials have been saved in your Let's Encryptconfiguration directory at /etc/letsencrypt. You should make asecure backup of this folder now. This configuration directory willalso contain certificates and private keys obtained by Let'sEncrypt so making regular backups of this folder is ideal.Job for nginx.service failed because the control process exited with error code. See "systemctl status nginx.service" and "journalctl -xe" for details.Connection to 192.241.225.94 closed.sudo: no tty present and no askpass program specified
Right so that's because the dns has not propogated. Give me 10 minutes and I'll take a look at your server.
From:Dominic ok
We still have a problem with the cloud-config script. The server is not setup right at all. Could you please paste the exact cloud config script you're using in to a file in the home dir of your administration droplet?
From:Dominic does the cloud config need to be checked while creating the droplet? cause if so that might be the issue
From:Dominic I checked the options for ipv6 and backups It's called "user data", which reveals a big text box into which you paste your modified Cloud config script
I see how that can be confusing
From:Dominic is it possible to set up after creating the droplet?
No
Actually that's something I've been meaning to Google
From:Dominic ok i’ll recreate the droplet
From:Dominic so what should I put in the user data? You need to copy the cloud config script into a text editor on your computer and modify the areas where you add your public SSH key and the IP address of your Administration droplet.
assets/cloud-config-wp · master · Neil / wp-adminGitLab.com GitLab
Once you've done that, copy and paste it into the user data area and make your droplet.
From:Dominic ok so this will create the dev user and everything correct?
Yes it creates the dev user it removes the need for the password for sudo access and sets up the firewall
And it installs lots of software
From:Dominic alirght so this is what we were missing earlier
Yup
This thread is going to improve the quality of the documentation significantly so thank you. It's very helpful to go through this with someone.
From:Dominic no worries lol, its nice to learn how to do it too
From:Dominic ok that droplet was recreated All right now we have to wait 5 minutes for that cloud script to do its magic and then you should be able to log in with your key on Port 9999
So now, you should update your .ssh/config and login once to accept the host key
From:Dominic ok that worked
From:Dominic no run wordpress-install?From:Dominic now* Now we need a domain
From:Dominic roammedia.ca
From:Dominic have all the dns info ready as well Yes, we need that a record to point at this droplet
From:Dominic alright
Every time I've done it lately with cloudflare the DNS has propagated almost immediately to digitalocean so hopefully we won't have to wait
Right now host roammedia.ca says: roammedia.ca has address 104.236.147.126
From:Dominic yea just about to update it
From your admin droplet
From:Dominic ok dns is updated
From:Dominic some of them have already swapped ??
Already swapped?
From:Dominic updated from the previous*
Neil Scudder shared a photo
Haha, that was hilariously fast
From:Dominic nice lol
So now you can run wordpress-install roammedia
Use the defaults and basic passwords, bc you're just setting up a dummy install to initialize things before we migrate the site over
From:Dominic hmm getting connection refused now
From:Dominic do I need to swap my .ssh/config from an ip over to the domain? No one sec
Wrong port 9999
From:Dominic oh right
It's always better to use the IP so you know exactly which machine you're connecting to
From:Dominic yea makes sense
From:Dominic ok its installing wp Right on
From:Dominic timed out on the cert again
Hmm
On the web server run this command host roammedia.ca
From:Dominic comes up with the new ip
The web server is using a different DNS resolver than your Administration droplet.
From:Dominic oh
From:Dominic that was admin one secFrom:Dominic oh thats itFrom:Dominic its still go the old oneFrom:Dominic got* They're both using Google DNS but I guess at very different ends of the cloud or something
We can move ahead with migrating the site though
From:Dominic alright
From:Dominic should there be files inside etc/www/html?From:Dominic oh there was another errorFrom:Dominic bash: -c: line 0: syntax error near unexpected token `('bash: -c: line 0: `		cd /var/www/html; 		wp core download; 		wp core config 			--dbhost=localhost 		--dbname=live 			--dbuser=wp 			--dbpass=nur(Z+mMzRm+; 		wp core install 			--url=roammedia.ca 	--title=Roam Media 			--admin_user=admin 			--admin_password=password 			--admin_email=dom@mediumrareinc.com 			--skip-email 		'Connection to 138.68.253.34 closed. I will run the WordPress install script again once the domain is resolved. It was interrupted.
From:Dominic oh ok
You need to generate a key pair for Dev user and share the public key to your Pantheon account so we can clone the repo
ssh-keygen -t rsa
From:Dominic k its added
From:Dominic whats the -t flag do Idk
From:Dominic lol
From:Dominic np
From:Nathaniel Tubb it specifies the type of key being generated ‘rsa’ vs ‘dsa’
This message was editedGo to var www and clone into a new dir, not html
Ah I copied from digitalocean Once you've cloned the repo, copy over the backup files from earlier
From:Nathaniel Tubb I’ve just been lurking here btw.
scp live.sql.gz roammedia:
scp files.tgz roammedia: That will drop them in dev's home dir Nothing on tv Nathaniel?
From:Nathaniel Tubb haha, nope, I had to break from following along earlier; now catching up.
From:Dominic alright those are moved over now
Extract the db file with gunzip live.sql.gz
From:Dominic ok
The DNS has propagated!
From:Dominic yayyyy
I will run the script again and see if I can get it to work
From:Tom Keenoy I took a break from writing a proposal to admire y'all working.
From:Dominic the show must go on!
The script didn't quite finish so I'm just going to mangle it manually for a minute
Ok, I finished the migration more or less, just put the pieces together a little more manually than normal. My dns hasn't propogated at home though, can't see it I think I need to check the web server configuration, getting a different response on my mobile data
From:Dominic hmm ok, its not loading for me either, but the dns has propgated
I did not unzip the files archive which needs to be done
Connection refused?
From:Dominic yea
sudo nginx -t  is a simple command to test the engine X configuration which is now telling me the web server software can't run because it can't find the right SSL certificate. So I need to run letsencrypt again
From:Dominic oh cool
From:Dominic thats a good place to start The trick here is that the web server won't run until it gets the right certs but it needs to run in order to get the certs so I have separate web server configuration for this purpose in /etc/nginx/sites-available which I am now loading temporarily
From:Dominic thats a bit of a paradox
Alright site seems to be running now we need those files unzipped in the uploads dir
Which you seem to have done
From:Dominic i did not lol
From:Dominic they may be from initial wp install No, this is the repo...
I see their generated since the site has been running They're The site looks pretty messed up even with the uploads in place
From:Dominic so is the site hosted in html or html-bup
html
From:Dominic yea im not seeing any uploads, the site uses a premium theme as well, so its possible it generated the uploads folder as well
When you grabbed the backup from Pantheon did you specify the dev environment?
From:Dominic yea
From:Dominic the site was built on devFrom:Dominic and left there because we were going to be moving to digital ocean Ok, I dont get what's wrong
From:Dominic the db may need a find and replace
From:Dominic stylesheet is still the link for my local Oh hang on
Yes I'll do the search and replace Ahhhhhh, that did it
From:Dominic hmmm fonts arent appearing right
Neil Scudder shared a photo
Neil Scudder shared a photo
Is that wrong?
From:Dominic yea
From:Dominic should beFrom:Dominichttp://dev-roam-media.pantheonsite.io/
From:Dominic like that
From:Dominic most of it looks right just the fontsFrom:Dominic may be a theme issue thoughWe now need to set up a git lab repo and git Auto deploy although I'm not sure I'm up for that right now
From:Dominic yea the font is missing from the theme drop down
From:Amanda Woloshyn hey guys, thanks so much for all the work that has gone into this.
From:Amanda Woloshyn Its not the end of the world if the launch isn’t completeFrom:Amanda Woloshyn ata llFrom:Amanda Woloshyn at allFrom:Amanda Woloshyn get some rest 
From:Dominic we will soon
From:Dominic i think the problem with the fonts is write permission relatedFrom:Dominic the premium theme doesnt appear to be able to update any of the cssHmm I thought I chowned everything for the www-data user, where does it write to?
From:Dominic im not sure
The cveds-dcv site needed a banners dir manually created in the wp-content folder, maybe it's something like that
From:Dominic acutally i think it outputs styles to the database
From:Dominic so it reads from the database, then inputs directly into the page with inline cssFrom:Dominic ok put in a manual fix for nowLooks great
Found some broken links, the samples from this page https://roammedia.ca/services
From:Dominic oh some of the images are still pulling from the dev site
I'll check the search replace again
From:Dominic some of those links are broken on dev as well
From:Dominic im guessing they might be persistant from the initial clone, so I wouldnt worry about it atmThere is definitely more urals to be replaced. Can you give me the full Dev URL please?
This localhost thing threw me off
From:Dominichttp://dev-roam-media.pantheonsite.io/
From:Dominic when uploading our local database to pantheon it never runs a find and replace, so some urls are still set to local host, where newer ones change to dev
Made 54 Replacements but it doesn't seem to have changed anything
From:Dominic the image links updated for me
Fixed a little error, the image links work but not "clock here for samples" links
From:Dominic i have a feeling they werent set up to begin with
From:Dominic I think the links are supposed to go to roammedia.ca/porfolio with the filter query coming afterFrom:Dominic is there a way to replace those links or will I have to edit through wordpress?This message was editedLet me lool
Lookwp search-replace "https://roammedia.ca/design-illustration" "https://roammedia.ca/portfolio" --skip-columns=guid --dry-run
Remove the dry run argument when you're ready to commit to the changes
From:Dominic cool that did it
From:Dominic thanks again for your help Neil, would have gotten so lost without you
Sent on:12:15 amNext time will be a lot easier
Sent on:12:17 am
From:Dominic hopefully
Sent on:12:17 amFrom:Dominic it started to get easier after remaking the droplet a few timesThat's how I work, just keep screwing it up and throwing it out. Seems to be the fastest way to success.
Sent on:12:18 am
From:Dominic you learn best from mistakes
Sent on:12:19 amFrom:Dominic its super nice too that you can instantly set up a new droplet as wellYeah

