#!/bin/bash

# Run the latest version of certbot in docker
# Supports wildcard certs
# Requires https://hub.docker.com/r/certbot/dns-digitalocean/
# Install docker with apt-get install docker.io
# Docs:
# https://certbot-dns-digitalocean.readthedocs.io/en/latest/
# https://certbot.eff.org/docs/install.html#running-with-docker
# (The -v switch links local:remote)

USAGE="
Usage: le-wildcard DOMAIN

Must be run as root.
You will be asked to provide a token for Digitalocean
if a configuration file does not exist in /etc/letsencrypt.
Appends *. to DOMAIN for wildcard
"
# Print USAGE if no args
if [ $# -lt 1 ]; then
    echo "$USAGE"
    exit 1
fi
if ! [ $(id -u) = 0 ]; then
    echo "This script must be run as root."
    exit 1
fi

function main {
    local CREDENTIALS DOMAIN WILDDOMAIN
    DOMAIN="$1"
    WILDDOMAIN="*.${1}"
    CREDENTIALS="/etc/letsencrypt/${DOMAIN}.ini"
    if [ ! -f "$CREDENTIALS" ]; then
        read -p "Digitalocean token is required for ${DOMAIN}: " -r
        echo "/n"
        echo "dns_digitalocean_token = ${REPLY}" > "$CREDENTIALS" 
        [ $? -eq 0 ] && echo "Configuration file ${CREDENTIALS} written."
        chmod 600 "$CREDENTIALS"
    fi
    docker run -it --rm --name certbot \
        -v "/etc/letsencrypt:/etc/letsencrypt" \
        -v "/var/lib/letsencrypt:/var/lib/letsencrypt" \
        certbot/dns-digitalocean \
        --server https://acme-v02.api.letsencrypt.org/directory \
        certonly \
        --dns-digitalocean-credentials "$CREDENTIALS" \
        -d "$WILDDOMAIN"
    chgrp mri -R /etc/letsencrypt/archive
}

main "$@"

exit 0
