#!/bin/bash

args="--path=/var/www/html"
# See wordpress-list for explanation of this code:
ssh -q ${1} "\
	[ -f /usr/local/bin/wp ] \
	&& wp --quiet $args core is-installed \
	|| exit 1" < /dev/null
if [ ! $? -eq 0 ]; then
	echo "${1} is not online. Proceed manually."
	exit 1
fi

target=${1}.sql
backupDir="/var/backups/wordpress"

function rotate()
{
	i="24"
	while [ $i -gt 0 ]
	do
		if [ $i -gt 1 ]; then
			h=$[i-1]
			mv ${1}.${h}.sql.gz ${1}.${i}.sql.gz >/dev/null 2>&1
		else
			mv ${1}.sql.gz ${1}.1.sql.gz >/dev/null 2>&1
		fi
		(( i-- ))
	done
}
# Next line checks if there is a second argument
if [ ${2+x} ]; then
	if [ $2 == "daily" ]; then
		cd ${backupDir}/daily
		rotate $1
	elif [ $2 == "hourly" ]; then
		cd ${backupDir}/hourly
		rotate $1
	elif [ $2 == "tmp" ]; then
		cd /tmp
		rotate $1
	fi
else
	# Set second positional argument
	set -- ${1} "manual"
	cd ${backupDir}/manual
	rotate $1
fi

args="--path=/var/www/html"
ssh ${1} "\
	wp ${args} db export /var/www/${target}; \
	gzip -vf /var/www/${target}"
scp ${1}:/var/www/${target}.gz .

echo $(date) "Backup completed for ${1} (${2})" 

exit 0
