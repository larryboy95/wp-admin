#!/bin/bash
USAGE="
$(basename $0) Version 0.1.4

Usage: wordpress-backup HOSTNAME BACKUPTYPE [WEBROOT]
Where:
- HOSTNAME must be available in ssh config
- BACKUPTYPE can be one of:
    - full: backup webroot and db to s3, rotated
    - manual: full backup to BUPDIR/manual, not rotated
    - db: backup db to admin server
    - tmp: backup db and webroot to /tmp on admin server
- WEBROOT is optional, defaults to /var/www/html

Configure Restic for s3
=======================
Add the following information to ~/.wp-admin:

export RESTIC_REPOSITORY="s3:https://s3-ca-central-1.amazonaws.com/backups.domain.com/restic"
export RESTIC_PASSWORD=""

# AWS
export AWS_ACCESS_KEY_ID=""
export AWS_SECRET_ACCESS_KEY=""
"

# Print USAGE if no args
if [ $# -eq 0 ]; then
    echo "$USAGE"
    exit 1
fi
# Check if already running
if ! mkdir -p ~/tmp/wordpress-backup.lock; then
	printf "Failed to acquire lock. (Script already running?)\n" >&2
	exit 1
fi
# Remove the lockdir on exit
trap 'rm -rf ~/tmp/wordpress-backup.lock' EXIT	

HOSTNAME="$1"
# Set defaults if arguments absent
BACKUPTYPE="${2:-manual}"
WEBROOT="${3:-/var/www/html}"
DBFNAME="${HOSTNAME}.sql"
EXCLUDE="sites/default/files/legacy"
# Below can be set as environment variables
BUPDIR="${BUPDIR:-/var/backups/wordpress}"
FULLBUPDIR=""
KEEP=${KEEP:-28}
RESTIC=${RESTIC:-/usr/local/bin/restic}
TEASER="${HOSTNAME} (${BACKUPTYPE}) at ${SITEURL}"
SITEURL=""
WPARGS="--path=${WEBROOT} --allow-root"

function restic-check {
	if [ -f "$RESTIC" ] && [ -f "${HOME}/.wp-admin" ]; then
		. "${HOME}/.wp-admin"
	else
		notify \
            "Restic or ~/.wp-admin config file not found for ${USER}@${HOSTNAME}, backup to s3 for ${HOSTNAME} is not happening." critical
	fi
}

# Look for the wp-cli binary, if found then run test to see if wp installed
function wp-check {
    ssh -q ${HOSTNAME} \
        "wp --quiet \
        ${WPARGS} \
        core is-installed" \
        < /dev/null
    if [ ! $? -eq 0 ]; then
        notify "${HOSTNAME} \
            WP does not appear to be running. What the heck?" \
            critical
        exit 1
    fi
    SITEURL=$(ssh ${HOSTNAME} \
        "wp ${WPARGS} \
        option get siteurl")
    [ -z "$SITEURL" ] && { echo "SITEURL is empty."; exit 1; }
}

function check-args {
    if [ "$HOSTNAME" == "full" ] \
        || [ "$HOSTNAME" == "db" ] \
        || [ "$HOSTNAME" == "manual" ] \
        || [ "$HOSTNAME" == "tmp" ]; then
        notify "Error in first argument, ${HOSTNAME} (arg1) ${BACKUPTYPE} (arg 2) backup." critical
        exit 1
    fi
    if [ "$BACKUPTYPE" != "full" ] \
        && [ "$BACKUPTYPE" != "db" ] \
        && [ "$BACKUPTYPE" != "manual" ] \
        && [ "$BACKUPTYPE" != "tmp" ]; then
        notify "Error in second argument, ${HOSTNAME} (arg 1) ${BACKUPTYPE} (arg 2) backup." critical
        exit 1
    fi
}

function set-backup-dir {
    case "$BACKUPTYPE" in
    "db") 
        DBFNAME=${HOSTNAME}-dbonly.sql
        ;;
    "manual") 
        local DATESTAMP=$(date +%F)
        DBFNAME="${HOSTNAME}-${DATESTAMP}.sql"
        BUPDIR="${BUPDIR}/manual"
	    FULLBUPDIR="${BUPDIR}/${HOSTNAME}-${DATESTAMP}"
        ;;
	"full") 
        FULLBUPDIR="${BUPDIR}/${HOSTNAME}"
        ;;
    "tmp") 
        BUPDIR="/tmp"
	    FULLBUPDIR="${BUPDIR}/${HOSTNAME}"
        ;;
    esac
    [ ! -d $BUPDIR ] && mkdir $BUPDIR
    cd ${BUPDIR}
    pwd
}

function rotate-db-backups {
    local h i
	echo "Rotate db backups"
	i=$KEEP
	while [ $i -gt 0 ]
	do
		if [ $i -gt 1 ]; then
			h=$[i-1]
			if [ -f ${HOSTNAME}.${h}.sql.gz ]; then
				mv ${HOSTNAME}.${h}.sql.gz \
                ${HOSTNAME}.${i}.sql.gz \
                >/dev/null 2>&1
			fi
		else
			if [ -f ${HOSTNAME}.sql.gz ]; then
				mv ${HOSTNAME}.sql.gz \
                ${HOSTNAME}.1.sql.gz \
                >/dev/null 2>&1
			fi
		fi
		(( i-- ))
	done
}

function rotate-dbonly-backups {
    local h i
	echo "Rotate dbonly backups"
	i=$KEEP
	while [ $i -gt 0 ]
	do
		if [ $i -gt 1 ]; then
			h=$[i-1]
			if [ -f ${HOSTNAME}-dbonly.${h}.sql.gz ]; then
				mv ${HOSTNAME}-dbonly.${h}.sql.gz \
                ${HOSTNAME}-dbonly.${i}.sql.gz \
                >/dev/null 2>&1
			fi
		else
			if [ -f ${HOSTNAME}-dbonly.sql.gz ]; then
				mv ${HOSTNAME}-dbonly.sql.gz \
                ${HOSTNAME}-dbonly.1.sql.gz \
                >/dev/null 2>&1
			fi
		fi
		(( i-- ))
	done
}

function dump-db {
    ssh ${HOSTNAME} "wp ${WPARGS} \
        db export ${WEBROOT}/../${DBFNAME}"
    if [ ! $? -eq 0  ]; then
        notify "Database export failed for ${TEASER}" critical
        exit 1
    fi
    ssh ${HOSTNAME} "gzip -vf ${WEBROOT}/../${DBFNAME}"
    if [ ! $? -eq 0  ]; then
        notify "Backup gzip failed for ${TEASER}" critical
        exit 1
    fi
    scp ${HOSTNAME}:${WEBROOT}/../${DBFNAME}.gz .
    if [ ! $? -eq 0  ]; then
        notify "DB scp failed for ${TEASER}" critical
        exit 1
    fi
}

function sync-files {
	[ ! -d $FULLBUPDIR ] && mkdir $FULLBUPDIR
    echo "Sync from ${HOSTNAME}"
	rsync \
        -vptLr \
        --exclude=${EXCLUDE} \
        --delete \
        ${HOSTNAME}:${WEBROOT} \
        ${FULLBUPDIR}
    if [ ! $? -eq 0  ]; then
        notify "File sync failed for ${TEASER}" critical
    fi
}

function backup-full {
	$RESTIC backup ${FULLBUPDIR}/ --tag ${HOSTNAME}
    [ ! $? -eq 0  ] && notify "Restic error" critical
}

function backup-db {
	$RESTIC backup ${DBFNAME}.gz --tag ${HOSTNAME}
    [ ! $? -eq 0  ] && notify "Restic error" critical
}

check-args 
set-backup-dir
wp-check
if [ -z "$3" ]; then
    wordpress-permissions "$HOSTNAME" dev
fi
echo "Proceeding with backup for ${HOSTNAME}."

if [ ${BACKUPTYPE} = "db" ]; then
	echo "Database backup, skipping full sync."
    rotate-dbonly-backups
    dump-db
elif [ ${BACKUPTYPE} = "tmp" ]; then
	echo "Backup db to /tmp, skipping restic."
    echo "This backup will not be written to s3."
    dump-db
    sync-files
elif [ ${BACKUPTYPE} = "manual" ]; then
	echo "Skipping restic."
    echo "This backup will not be written to s3."
    dump-db
    sync-files
else
    restic-check
    rotate-db-backups
    dump-db
    backup-db
    sync-files
    backup-full
fi
notify \
    "Backup (${BACKUPTYPE}) completed for ${SITEURL}. Post-backup screenshot:" \
    "$SITEURL" 
if [ ! $? -eq 0  ]; then
    notify "Screenshot tweet failed for ${TEASER}" critical
    exit 1
fi

exit 0
