#!/bin/bash

target=${1}.sql

if [ $2 == "manual" ]; then
		cd ~/backups-db-manual
		pwd
		echo "Write manual backup"
		echo "Rotate backups"
		mv -v ${1}.7.sql.gz ${1}.8.sql.gz
		mv -v ${1}.6.sql.gz ${1}.7.sql.gz
		mv -v ${1}.5.sql.gz ${1}.6.sql.gz
		mv -v ${1}.4.sql.gz ${1}.5.sql.gz
		mv -v ${1}.3.sql.gz ${1}.4.sql.gz
		mv -v ${1}.2.sql.gz ${1}.3.sql.gz
		mv -v ${1}.1.sql.gz ${1}.2.sql.gz
		mv -v ${1}.sql.gz ${1}.1.sql.gz
elif [ $2 == "temp" ]; then
		cd /tmp
		pwd
		echo "Write new backup to /tmp"
		echo "Rotate backups"
		mv -v ${1}.7.sql.gz ${1}.8.sql.gz
		mv -v ${1}.6.sql.gz ${1}.7.sql.gz
		mv -v ${1}.5.sql.gz ${1}.6.sql.gz
		mv -v ${1}.4.sql.gz ${1}.5.sql.gz
		mv -v ${1}.3.sql.gz ${1}.4.sql.gz
		mv -v ${1}.2.sql.gz ${1}.3.sql.gz
		mv -v ${1}.1.sql.gz ${1}.2.sql.gz
		mv -v ${1}.sql.gz ${1}.1.sql.gz
else
		cd ~/backups-db-daily
		pwd
		echo "Write daily backup"
		echo "Rotate backups"
		mv -v ${1}.7.sql.gz ${1}.8.sql.gz
		mv -v ${1}.6.sql.gz ${1}.7.sql.gz
		mv -v ${1}.5.sql.gz ${1}.6.sql.gz
		mv -v ${1}.4.sql.gz ${1}.5.sql.gz
		mv -v ${1}.3.sql.gz ${1}.4.sql.gz
		mv -v ${1}.2.sql.gz ${1}.3.sql.gz
		mv -v ${1}.1.sql.gz ${1}.2.sql.gz
		mv -v ${1}.sql.gz ${1}.1.sql.gz
fi

# Setup ssh hosts first in ~/.ssh/config
args="--path=/var/www/html --ssh=$1"

echo "Export db from WordPress..."
wp $args db export - > "${target}"

# Zip that shit up
gzip -vf ${target}

exit 0
