#!/bin/bash

target=${1}.sql
daily="~/backups-db-daily"
manual="~/backups-db-manual"
wp=$(which wp)
gzip=$(which gzip)

function rotate()
{
	echo "Rotate backups"
	mv -v ${1}.7.sql.gz ${1}.8.sql.gz
	mv -v ${1}.6.sql.gz ${1}.7.sql.gz
	mv -v ${1}.5.sql.gz ${1}.6.sql.gz
	mv -v ${1}.4.sql.gz ${1}.5.sql.gz
	mv -v ${1}.3.sql.gz ${1}.4.sql.gz
	mv -v ${1}.2.sql.gz ${1}.3.sql.gz
	mv -v ${1}.1.sql.gz ${1}.2.sql.gz
	mv -v ${1}.sql.gz ${1}.1.sql.gz
}

if [ $2 == "manual" ]; then
	cd $manual
	pwd
	echo "Write manual backup"
	rotate $1
elif [ $2 == "daily" ]; then
	cd $daily
	pwd
	echo "Write daily backup"
	rotate $1
elif [ $2 == "temp" ]; then
	cd /tmp
	pwd
	echo "Write new backup to /tmp"
	rotate $1
else
	exit 1
fi

# Setup ssh hosts first in ~/.ssh/config
args="--path=/var/www/html --ssh=$1"

echo "Export db from WordPress..."
$wp $args db export - > "${target}"

# Zip that shit up
$gzip -vf ${target}

echo $(date) "Backup completed" 

exit 0
