#!/bin/bash
USAGE="
$(basename $0) Version 0.1.3

Usage: $(basename $0) URL MESSAGE 

Takes screenshots of URL and attaches to tweet.
Sends MESSAGE as a tweet from the non-critical account.
Configured in ~/.tw.conf

Depends on:
- https://github.com/piroor/tweet.sh
- https://github.com/hrs/markov-sentence-generator
- https://github.com/sindresorhus/pageres-cli
"
# Print USAGE if no args
if [ $# -eq 0 ]; then
    echo "$USAGE"
    exit 1
fi

cd /tmp
tempURLs=".tw-urls.tmp"
tempJPG="tw-tmp"
n=2
pargs="--crop --delay=2 --format=jpg"
if [ -f /usr/local/bin/tweet.sh ]; then
	. ~/.tw.conf
	rm ${tempJPG}-*.jpg
	curl -s "$1" \
		| grep -Po '(?<=href=")[^"]*' \
		| grep "$1" \
		| grep -v '.css\|rss\|xml\|json\|feed\|.ico\|.jpg\|.png\|.js\|.svg\|?' \
		| awk '{ print length($0) " " $0; }' $file \
		| sort -r -n \
		| cut -d ' ' -f 2- \
		| uniq \
		| head -n 2 \
		> ${tempURLs};
	pageres $pargs --filename="${tempJPG}-0" ${1} 1600x2100
	pageres \
		$pargs \
		--userAgent 'Mozilla/5.0 (Linux; Android 6.0.1; Nexus 6P Build/MMB29P) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.83 Mobile Safari/537.36' \
		--filename="${tempJPG}-1" \
		${1}\
		700x2100
	mid[0]=$(tweet.sh upload ${tempJPG}-0.jpg | jq -r '.media_id_string')
	mid[1]=$(tweet.sh upload ${tempJPG}-1.jpg | jq -r '.media_id_string')
	while IFS='' read -r line || [[ -n "$line" ]]; do
		pageres $pargs --filename="${tempJPG}-${n}" ${line} 1600x2100
		((n++))
	done < "${tempURLs}"
	mid[2]=$(tweet.sh upload ${tempJPG}-2.jpg | jq -r '.media_id_string')
	mid[3]=$(tweet.sh upload ${tempJPG}-3.jpg | jq -r '.media_id_string')
	echo ${mid[@]}
	rm ${tempJPG}-*.jpg
	rm ${tempURLs}
	markov=$(/opt/markov-sentence-generator/sentence-generator.py /opt/markov-sentence-generator/360.txt.utf-8 5 | cut -d " " -f 1-20)
	tweet.sh post -m ${mid[0]},${mid[1]},${mid[2]},${mid[3]} "${2} ${markov}"
fi
exit 0
