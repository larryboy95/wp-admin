#!/bin/bash
cd /tmp
tempURLs=".tw-urls.tmp"
tempJPG="tw-tmp"
n=2
pargs="--crop --delay=2 --format=jpg"
if [ -f /usr/local/bin/tweet.sh ]; then
	. ~/.tw.conf
	rm ${tempJPG}-*.jpg
	curl -s "$1" \
		| grep -Po '(?<=href=")[^"]*' \
		| grep "$1" \
		| grep -v '.css\|rss\|xml\|json\|feed\|.ico\|.jpg\|.png\|.js' \
		| awk '{ print length($0) " " $0; }' $file \
		| sort -r -n \
		| cut -d ' ' -f 2- \
		| uniq \
		| head -n 2 \
		> ${tempURLs};
	pageres $pargs --filename="${tempJPG}-0" ${1} 1600x2100
	pageres \
		$pargs \
		--userAgent 'Mozilla/5.0 (Linux; Android 4.0.4; Galaxy Nexus Build/IMM76B) AppleWebKit/535.19 (KHTML, like Gecko) Chrome/18.0.1025.133 Mobile Safari/535.19' \
		--filename="${tempJPG}-1" \
		${1}\
		700x2100
	mid[0]=$(tweet.sh upload ${tempJPG}-0.jpg | jq -r '.media_id_string')
	mid[1]=$(tweet.sh upload ${tempJPG}-1.jpg | jq -r '.media_id_string')
	while IFS='' read -r line || [[ -n "$line" ]]; do
		pageres $pargs --filename="${tempJPG}-${n}" ${line} 1600x2100
		((n++))
	done < "${tempURLs}"
	mid[2]=$(tweet.sh upload ${tempJPG}-2.jpg | jq -r '.media_id_string')
	mid[3]=$(tweet.sh upload ${tempJPG}-3.jpg | jq -r '.media_id_string')
	echo ${mid[@]}
	rm ${tempJPG}-*.jpg
	rm ${tempURLs}
	tweet.sh post -m ${mid[0]},${mid[1]},${mid[2]},${mid[3]} "${2} $(date +%s)"
fi
exit 0
