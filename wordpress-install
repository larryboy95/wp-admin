#!/bin/bash

error_exit() {
	local lc="$BASH_COMMAND" rc=$?
	echo "Command [$lc] exited with code [$rc]"
	rm -f /tmp/stupid
	rm -rf /tmp/nginx-*
	rm -f /tmp/${fqdn}*
}
trap error_exit EXIT
set -e

main() 
{
	scriptdir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
	read -p "Database host: [localhost] " dbhost
	dbhost=${dbhost:-localhost}
	read -p "Database user: [wp] " dbuser
	dbuser=${dbuser:-wp}
	read -p "Database name: [live] " dbname
	dbname=${dbname:-live}
	read -p "Database password: " dbpass
	read -p "Domain (no http://, no www): " fqdn
	read -p "Site title: [Title] " title
	title=${title:-Title}
	read -p "WP Admin User: [admin] " user
	user=${user:-admin}
	read -p "WP Admin Password: " password
	read -p "Email (must be valid): " email

	cd ${scriptdir}
	cp -vr assets/nginx-* /tmp

	# if dbname or fqdn empty abort	
	[[ -z $dbname ]] && exit "db Name must not be empty"
	[[ -z $fqdn ]] && exit "domain name must not be empty"
	ssh -t ${1} "\
		cd /var/www/html; \
		wp core download; \
		wp core config \
			--dbhost=${dbhost} \
			--dbname=${dbname} \
			--dbuser=${dbuser} \
			--dbpass=${dbpass}; \
		wp core install \
			--url=${fqdn} \
			--title=${title} \
			--admin_user=${user} \
			--admin_password=${password} \
			--admin_email=${email} \
			--skip-email \
		" 
}

main ${1}
exit 0		
