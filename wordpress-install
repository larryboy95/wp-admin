#!/bin/bash

error_exit() {
	local lc="$BASH_COMMAND" rc=$?
	echo "Command [$lc] exited with code [$rc]"
}
trap error_exit EXIT

main() 
{
	scriptdir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
	read -p "Database host: [localhost] " dbhost
	dbhost=${dbhost:-localhost}
	read -p "Database user: [wp] " dbuser
	dbuser=${dbuser:-wp}
	read -p "Database name: [live] " dbname
	dbname=${dbname:-live}
	read -p "Database password: " dbpass
	read -p "Domain (no http://, no www): " fqdn
	read -p "Site title: [Title] " title
	title=${title:-Title}
	read -p "User: [admin] " user
	user=${user:-admin}
	read -p "Password: " password
	read -p "Email: " email

	# check if dir exists
	cd ${scriptdir}
	cp -vr assets/nginx-* /tmp
	
	sed -i -e "s/BRANCH/${dbname}/g" /tmp/nginx-wordpress
	sed -i -e "s/FQDN/${fqdn}/g" /tmp/nginx-wordpress
	sed -i -e "s/FQDN/${fqdn}/g" /tmp/nginx-snippets/ssl-certs.conf
	scp -r /tmp/nginx-* ${1}:

	ssh -t ${1} "[ ! -f /etc/nginx/sites-available/nginx-letsencrypt ] && sudo mv nginx-letsencrypt /etc/nginx/sites-available/"
	ssh -t ${1} "sudo mv nginx-wordpress /etc/nginx/sites-available/"
	ssh -t ${1} "sudo mv nginx-snippets/* /etc/nginx/snippets/"
	ssh -t ${1} "sudo rm /etc/nginx/sites-enabled/*"
	ssh -t ${1} "sudo ln -s /etc/nginx/sites-available/nginx-letsencrypt /etc/nginx/sites-enabled/"
	# check if exists already
	ssh -t ${1} "sudo service nginx restart"
	# check dns resolution
	# check if certs exist before proceeding
	ssh -t ${1} "sudo letsencrypt certonly -a webroot --webroot-path=/var/www/html -d ${fqdn}"
	# check that certs exist before proceeding
	ssh -t ${1} "sudo rm /etc/nginx/sites-enabled/nginx-letsencrypt"
	ssh -t ${1} "sudo ln -s /etc/nginx/sites-available/nginx-wordpress /etc/nginx/sites-enabled/"
	ssh -t ${1} "sudo service nginx restart"

	ssh ${1} "sudo cat /root/.digitalocean_password" > /tmp/stupid
	source /tmp/stupid
	rm -f /tmp/stupid
	myargs="-s -u root -p${root_mysql_pass} -e"
	ssh ${1} "mysql ${myargs} \"drop database ${dbname};\"" \
	ssh ${1} "mysql ${myargs} \"create database ${dbname};\"" \
	ssh ${1} "mysql ${myargs} \"create user '${dbuser}'@'${dbhost}' identified by '${dbpass}';\"" \
	ssh ${1} "mysql ${myargs} \"grant all privileges on ${dbname}.* to '${dbuser}'@'${dbhost}';\"" \
	ssh ${1} "mysql ${myargs} \"flush privileges;\"" \
	ssh -t ${1} "\
		cd /var/www/html; \
		wp core download; \
		wp core config \
			--dbhost=${dbhost} \
			--dbname=${dbname} \
			--dbuser=${dbuser} \
			--dbpass=${dbpass}; \
		wp core install \
			--url=${fqdn} \
			--title=${title} \
			--admin_user=${user} \
			--admin_password=${password} \
			--admin_email=${email} \
			--skip-email \
		" 
}

set -e
main ${1}
exit 0		
