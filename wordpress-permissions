#!/bin/bash

USAGE="
$(basename $0) Version 0.1.1

Usage: $(basename $0) HOSTNAME [OWNER WEBROOT]

Change primary owner of webroot to OWNER
while preserving write permissions for
web server to appropriate directories.
Sets all files to 640 and all directories
to 750. wp-config.php is owned by root, 644.

Defaults:
OWNER, dev
WEBROOT, /var/www/html
"
# Print USAGE if no args
if [ $# -eq 0 ]; then
    echo "$USAGE"
    exit 1
fi
HOSTNAME="$1"
# If OWNER is not supplied, ask for it
if [ $# -eq 1 ]; then
	read -p "User: [dev]" OWNER
	OWNER=${OWNER:-dev}
else
	OWNER=${2}
fi
WEBROOT="${3:-/var/www/html}"
ssh "$1" "[ -d ${WEBROOT} ] || exit 1"
if [ $? -eq 1 ]; then
    echo "Webroot not found"
    exit 1
else
    ssh "$1" "sudo chown -R ${OWNER}:www-data ${WEBROOT};"
    if [ ! $? -eq 0 ]; then
        notify-critical "Permissions error on ${HOSTNAME}"
        exit 1
    fi
    ssh "$1" "sudo chown ${OWNER}:www-data ${WEBROOT}/..;"
    ssh "$1" "sudo chown root:www-data ${WEBROOT}/wp-config.php;"
    ssh "$1" "[ -d ${WEBROOT}/wp-content/uploads ] && \
        sudo chown -R www-data:${OWNER} ${WEBROOT}/wp-content/uploads; \
        [ -d ${WEBROOT}/wp-content/banners ] && \
        sudo chown -R www-data:${OWNER} ${WEBROOT}/wp-content/banners; \
        [ -d ${WEBROOT}/wp-content/plugins/wpspx/cache ] && \
        sudo chown -R www-data:${OWNER} ${WEBROOT}/wp-content/plugins/wpspx/cache;
    "
    ssh "$1" "[ -d ${WEBROOT}/wp-content/uploads ] && \
        sudo chmod g+s -R ${WEBROOT}/wp-content;"
    ssh "$1" "sudo find ${WEBROOT} -type f -exec chmod 640 {} +; \
        sudo find ${WEBROOT} -type d -exec chmod 750 {} +;
        sudo chmod 644 ${WEBROOT}/wp-config.php;
    "
    if [ $? -eq 0 ]; then
        echo "Permissions updated on ${HOSTNAME}"
    else
        notify-critical "Permissions error on ${HOSTNAME}"
        exit 1
    fi
fi
exit 0
