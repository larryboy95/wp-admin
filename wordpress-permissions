#!/bin/bash

USAGE="
Usage: $(basename $0) HOST [USER WEBROOT]

Change primary owner of webroot to USER
while preserving write permissions for
web server to appropriate directories.
Sets all files to 644 and all directories
to 755.
"
# Print USAGE if no args
if [ $# -eq 0 ]; then
    echo "$USAGE"
    exit 1
fi
HOST="$1"
# If USER not supplied, ask for it
if [ $# -eq 1 ]; then
	read -p "User: [dev]" OWNER
	OWNER=${OWNER:-dev}
else
	OWNER=${2}
fi
WEBROOT="${3:-/var/www/html}"
ssh ${1} "sudo chown -R ${OWNER}:www-data ${WEBROOT};"
ssh ${1} "sudo chown ${OWNER}:www-data ${WEBROOT}/..;"
ssh ${1} "sudo chown root:www-data ${WEBROOT}/wp-config.php;"
ssh ${1} "[ -d ${WEBROOT}/wp-content/uploads ] && \
    sudo chown -R www-data:${OWNER} ${WEBROOT}/wp-content/uploads; \
    [ -d ${WEBROOT}/wp-content/banners ] && \
    sudo chown -R www-data ${WEBROOT}/wp-content/banners; \
    [ -d ${WEBROOT}/wp-content/plugins/wpspx-master/cache ] && \
    sudo chown -R www-data ${WEBROOT}/wp-content/plugins/wpspx-master/cache;
"
ssh ${1} "sudo find ${WEBROOT} -type f -exec chmod 640 {} +; \
    sudo find ${WEBROOT} -type d -exec chmod 750 {} +;
"
exit 0
